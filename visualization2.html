<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap</title>
    Y <select id="y_axis_selection"></select> <button onclick="switch_axes()">&#8652;</button> 
    X <select id="x_axis_selection"></select>
    Incident <select id="value_selection_incident" class="optionDropdown">
        <option value="INJURED">Injured</option>
        <option value="KILLED">Killed</option>
    </select>
    Personnel <select id="value_selection_personnel" class="optionDropdown">
        <option value="PERSONS">All</option>
        <option value="CYCLIST">Cyclist</option>
        <option value="MOTORIST">Motorist</option>
        <option value="PEDESTRIANS">Pedestrians</option>
    </select>

    <style>
        h1 {
            font-family: sans-serif;
            text-align: center;
        }
        svg {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        svg text {
            font-size: 12px;
            font-family: sans-serif;
            fill: black;
        }
    </style>

    <script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src = 'load_data.js'></script>
</head>
<body>
    <h1>Heatmap</h1>
    <div class="chart"></div>
    <script>
        var margin = {top: 40, right: 150, bottom: 150, left: 150}
        var chartWidth = screen.width * 0.9 - margin.left - margin.right;
        var chartHeight = screen.height * 0.7 - margin.top - margin.bottom;
        var axisLabels = {"CRASH YEAR": "Year", "CRASH MONTH": "Month", "CRASH DAY_v2": "Day of Week", "CRASH HOUR": "Hour"};
        var format = d3.format(",");
        
        load_data.then(() => {
            makeChart(dataset);
        })

        function getValueWord(number, selection) {
            if (selection == "CRASH MONTH") {
                return MONTH[number];
            }
            if (selection == "CRASH DAY_v2") {
                return DAY[number];
            }
            return number;
        }

        function getDomain(selection) {
            if (selection == "CRASH YEAR") {
                var domain_min = d3.min(dataset.map(d => d["CRASH YEAR"]));
                var domain_max = d3.max(dataset.map(d => d["CRASH YEAR"]));
                return d3.range(domain_min, domain_max + 1);
            }
            if (selection == "CRASH MONTH") {
                return MONTH;
            }
            if (selection == "CRASH DAY_v2") {
                return DAY;
            }
            if (selection == "CRASH HOUR") {
                return d3.range(0, 24);
            }
        }

        function toTitleCase(str) {
            return str.charAt(0).toUpperCase() + str.substr(1).toLowerCase();
        }

        function makeChart(data) {
            var x_axis_selection = document.getElementById("x_axis_selection").value;
            var y_axis_selection = document.getElementById("y_axis_selection").value;
            var value_selection_incident = document.getElementById("value_selection_incident").value;
            var value_selection_personnel = document.getElementById("value_selection_personnel").value;
            var value_selection = "NUMBER OF " + value_selection_personnel + " " + value_selection_incident;

            var aggregated_data = d3.flatRollup(data, v => d3.sum(v, d => d[value_selection]), d => d[x_axis_selection], d => d[y_axis_selection])

            var x_domain = getDomain(x_axis_selection);
            var y_domain = getDomain(y_axis_selection);
            var value_min = d3.min(aggregated_data.map(d => d[2]));
            var value_max = d3.max(aggregated_data.map(d => d[2]));

            var svg = d3.select(".chart")
                .append("svg")
                .attr("width", chartWidth + margin.left + margin.right)
                .attr("height", chartHeight + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var x = d3.scaleBand()
                .domain(x_domain)
                .range([0, chartWidth]);

            var y = d3.scaleBand()
                .domain(y_domain)
                .range([0, chartHeight]);

            var c = d3.scaleSequential()
                .interpolator(t => d3.interpolateInferno(1 - t))
                .domain([value_min, value_max])
                .nice();

            var canvas = d3.select(".chart")
                .style("width", chartWidth)
                .style("height", chartHeight);

            // tooltip properties
            var tooltip = d3.select(".chart")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px")
                .style("position", "absolute")
                .style("pointer-events", "none");

            // create mouseover event which will show the tooltip
            var mouseover = function(event,d) {
                tooltip.transition()
                    .duration(100)
                    .style("opacity", .9);
                tooltip.html("<b>"+ axisLabels[y_axis_selection] +": </b>" + getValueWord(d[1], y_axis_selection) + ", \
                    <b>"+ axisLabels[x_axis_selection] +": </b>" + getValueWord(d[0], x_axis_selection) + "<br> \
                    <b>"+ "Number of " + toTitleCase(value_selection_personnel) + " " + toTitleCase(value_selection_incident) +": </b>" + format(d[2]))
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            // create mouseout event which will hide the tooltip
            var mouseout = function (d) {
                tooltip.transition()
                    .duration(100)
                    .style("opacity", 0)
            }

            var rectangles = svg.selectAll("rect")
                .data(aggregated_data);

            var enter = rectangles
                .join("rect")
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth());

            enter.merge(rectangles)
                .attr("x", function(d) {return x(getValueWord(d[0], x_axis_selection));})
                .attr("y", function(d) {return y(getValueWord(d[1], y_axis_selection));})
                .style("fill", function(d) {return c(d[2]);})
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            // X Axis created on the bottom
            var xAxis = svg.append("g")
                .attr("id", "x-axis")
                .attr("transform", "translate(0, " + chartHeight + ")")
                .call(d3.axisBottom(x))
            .append("text")
                .text(axisLabels[x_axis_selection])
                .attr("x", chartWidth/2)
                .attr("y", 40)
                .style("text-anchor", "middle")
                .style("font-weight", "bold");

            // Y Axis created on the left
            var yAxis = svg.append("g")
                .attr("id", "y-axis")
                .call(d3.axisLeft(y))
            .append("text")
                .text(axisLabels[y_axis_selection])
                .attr("x", -chartHeight/2)
                .attr("y", -80)
                .attr("transform", "rotate(-90)")
                .style("text-anchor", "middle")
                .style("font-weight", "bold");

            // legend axis linear scale using domain from colour sequential scale
            legendAxis = d3.scaleLinear()
                .domain(c.domain())
                .range([0, chartWidth])

            legendBarHeight = 10;

            const defs = svg.append("defs");
            const linearGradient = defs.append("linearGradient")
                .attr("id", "linear-gradient");
            
            linearGradient.selectAll("stop")
                .data(c.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: c(t) })))
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            // Heatmap legend created with rectangle filled with linear gradient, tick marks and legend title
            legend = svg.append("g")
                .attr("transform", `translate(0, ${chartHeight + 120})`)
                .call(d3.axisBottom(legendAxis)
                    .tickSize(legendBarHeight + 5));
            legend.append("rect")
                .attr("width", chartWidth)
                .attr("height", legendBarHeight)
                .style("fill", "url(#linear-gradient)")
            legend.append("text")
                .text("Number of " + toTitleCase(value_selection_personnel) + " " + toTitleCase(value_selection_incident))
                .attr("x", chartWidth/2)
                .attr("dy", -10)
                .style("text-anchor", "middle")
                .style("font-weight", "bold");
        }

        var x_axis_options = d3.select("#x_axis_selection")
            .attr("class", "optionDropdown")
            .selectAll('myOptions')
                .data(Object.keys(axisLabels))
            .enter()
                .append('option')
            .text(function (d) { return axisLabels[d]; })
            .attr("value", function (d) { return d; });

        var y_axis_options = d3.select("#y_axis_selection")
            .attr("class", "optionDropdown")
            .selectAll('myOptions')
                .data(Object.keys(axisLabels))
            .enter()
                .append('option')
            .text(function (d) { return axisLabels[d]; })
            .attr("value", function (d) { return d; });
            
        x_axis_options
            .property("selected", function(d){ return d === "CRASH MONTH"; });

        d3.selectAll(".optionDropdown")
            .on("change", function() {
                d3.select(".chart").selectAll("*").remove();
                makeChart(dataset);
            })

        function switch_axes() {
            var x_axis_selection = document.getElementById("x_axis_selection").value;
            var y_axis_selection = document.getElementById("y_axis_selection").value;
            x_axis_options
                .property("selected", function(d){ return d === y_axis_selection; });
            y_axis_options
                .property("selected", function(d){ return d === x_axis_selection; });
            d3.select(".chart").selectAll("*").remove();
            makeChart(dataset);
        }
    </script>
</body>
</html>